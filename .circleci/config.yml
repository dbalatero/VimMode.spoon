version: 2.1
orbs:
  macos: circleci/macos@1.0.0

jobs:
  build-test:
    macos:
      xcode: 11.7.0
    steps:
      - checkout
      - run: echo 'chruby ruby-2.7' >> ~/.bash_profile
      - run: echo "$(which ruby)"
      - run: echo "Dying early" && exit 1

      - macos/add-uitest-permissions

      - macos/add-permission:
          bundle-id: "org.hammerspoon.Hammerspoon"
          permission-type: "kTCCServiceAppleEvents"

      - macos/add-permission:
          bundle-id: "org.hammerspoon.Hammerspoon"
          permission-type: "kTCCServiceAccessibility"

      - macos/add-permission:
          bundle-id: "/usr/bin/osascript"
          permission-type: "kTCCServiceAppleEvents"

      - macos/add-permission:
          bundle-id: "/usr/bin/osascript"
          permission-type: "kTCCServiceAccessibility"

      - macos/add-permission:
          bundle-id: "com.google.Chrome"
          permission-type: "kTCCServiceAppleEvents"

      - macos/add-permission:
          bundle-id: "com.google.Chrome"
          permission-type: "kTCCServiceAccessibility"

      # Lua setup
      - run: pip3 install hererocks
      - run: hererocks $HOME/here -r^ --lua 5.4
      - run: export PATH=$PATH:$HOME/here/bin
      - run: eval `luarocks path --bin`
      - run: bin/dev-setup

      # Integration test setup
      - run: bundle install
      - run: brew cask install google-chrome
      - run: brew cask install hammerspoon

      - macos/list-permission-types

workflows:
  verify:
    jobs:
      - build-test
