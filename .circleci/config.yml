version: 2.1
orbs:
  macos: circleci/macos@1.0.0

jobs:
  build-test:
    macos:
      xcode: 11.7.0
    steps:
      - checkout
      - macos/add-uitest-permissions

      - macos/add-permission:
          bundle-id: "org.hammerspoon.Hammerspoon"
          permission-type: "kTCCServiceAppleEvents"

      - macos/add-permission:
          bundle-id: "org.hammerspoon.Hammerspoon"
          permission-type: "kTCCServiceAccessibility"

      - macos/add-permission:
          bundle-id: "com.google.Chrome"
          permission-type: "kTCCServiceAppleEvents"

      - macos/add-permission:
          bundle-id: "com.google.Chrome"
          permission-type: "kTCCServiceAccessibility"

      - run:
          name: Setting /usr/bin/osascript permissions
          command: |
            epochdate=$(($(date +'%s * 1000 + %-N / 1000000')))

            # system events osascript
            sudo sqlite3 "/Users/distiller/Library/Application Support/com.apple.TCC/TCC.db" \
              "REPLACE INTO access (service, client, client_type, allowed, prompt_count, policy_id, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES('kTCCServiceAppleEvents', '/usr/bin/osascript', 1, 1, 1, NULL, 0, 'com.apple.systemevents', NULL, $epochdate);"

            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" \
              "REPLACE INTO access (service, client, client_type, allowed, prompt_count, policy_id, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES('kTCCServiceAppleEvents', '/usr/bin/osascript', 1, 1, 1, NULL, 0, 'com.apple.systemevents', NULL, $epochdate);"

            # finder osascript (TODO: delete?)
            sudo sqlite3 "/Users/distiller/Library/Application Support/com.apple.TCC/TCC.db" \
              "REPLACE INTO access (service, client, client_type, allowed, prompt_count, policy_id, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES('kTCCServiceAppleEvents', '/usr/bin/osascript', 1, 1, 1, NULL, 0, 'com.apple.finder', NULL, $epochdate);"

            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" \
              "REPLACE INTO access (service, client, client_type, allowed, prompt_count, policy_id, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES('kTCCServiceAppleEvents', '/usr/bin/osascript', 1, 1, 1, NULL, 0, 'com.apple.finder', NULL, $epochdate);"

            # chrome osascript
            sudo sqlite3 "/Users/distiller/Library/Application Support/com.apple.TCC/TCC.db" \
              "REPLACE INTO access (service, client, client_type, allowed, prompt_count, policy_id, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES('kTCCServiceAppleEvents', '/usr/bin/osascript', 1, 1, 1, NULL, 0, 'com.google.Chrome', NULL, $epochdate);"

            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" \
              "REPLACE INTO access (service, client, client_type, allowed, prompt_count, policy_id, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES('kTCCServiceAppleEvents', '/usr/bin/osascript', 1, 1, 1, NULL, 0, 'com.google.Chrome', NULL, $epochdate);"

      - macos/list-permissions

      # Lua setup
      # - run: pip3 install hererocks
      # - run: hererocks $HOME/here -r^ --lua 5.4
      # - run: echo "export PATH=$PATH:$HOME/here/bin" >> ~/.bash_profile
      # - run: echo 'eval `luarocks path --bin`' >> ~/.bash_profile
      # - run: bin/dev-setup

      # # Run lua tests
      # - run: busted -c

      # Integration test setup
      - run: bin/ci-config
      - run: cat $HOME/.hammerspoon/init.lua

      - run: echo 'chruby ruby-2.6' >> ~/.bash_profile
      - run: gem install bundler
      - run: bundle install
      - run: brew cask install chromedriver
      - run: brew cask install google-chrome
      - run: brew cask install hammerspoon

      # Run integration tests
      - run: bundle exec rspec spec

workflows:
  verify:
    jobs:
      - build-test
